<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Prueba WebView</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="transparent" content="true">

</head>
<body>
    <div id="image-container"></div>
    <canvas id="canvas" width="1280" height="720"></canvas>
    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const elementosMap = new Map();

        function agregarObjetoDisplay(config) {
            const {
                IdGrupo,
                Id,
                Url = "",
                Texto = null,
                Ancho = 0,
                Alto = 0,
                PosX = 0,
                PosY = 0,
                Opacidad = 100
            } = config;

            if (Url) {
                const ext = Url.split(".").pop().toLowerCase();
                if (["webm", "mp4"].includes(ext)) {
                    reproducirVideo(Id, IdGrupo, Url, PosX, PosY, Ancho, Alto, Opacidad);
                } else {
                    const img = new Image();
                    img.onload = () => {
                        elementosMap.set(Id, {
                            grupo: IdGrupo,
                            tipo: "imagen",
                            recurso: img,
                            x: PosX,
                            y: PosY,
                            w: Ancho || img.width,
                            h: Alto || img.height,
                            alpha: Opacidad / 100
                        });
                    };
                    img.src = Url;
                }
            } else if (Texto) {
                elementosMap.set(Id, {
                    grupo: IdGrupo,
                    tipo: "texto",
                    recurso: Texto,
                    x: PosX,
                    y: PosY,
                    alpha: Opacidad / 100
                });
            }
        }

        // Render loop principal
        function renderLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            elementosMap.forEach(item => {
                if (item.tipo === "video") {
                    if (item.offscreen && item.frame) {
                        ctx.globalAlpha = item.alpha;
                        ctx.drawImage(item.offscreen, item.x, item.y, item.w, item.h);
                        ctx.globalAlpha = 1;
                    }
                } else if (item.tipo === "imagen") {
                    ctx.globalAlpha = item.alpha;
                    ctx.drawImage(item.recurso, item.x, item.y, item.w, item.h);
                    ctx.globalAlpha = 1;
                } else if (item.tipo === "texto") {
                    const t = item.recurso;
                    ctx.globalAlpha = item.alpha;
                    ctx.font = `${t.FontWeight || "normal"} ${t.FontSize || 24}px ${t.FontFamily || "sans-serif"}`;
                    ctx.fillStyle = t.Color || "#fff";
                    ctx.textAlign = t.Align || "left";
                    ctx.fillText(t.Contenido || "", item.x, item.y);
                    ctx.globalAlpha = 1;
                }
            });

            requestAnimationFrame(renderLoop);
        }
        requestAnimationFrame(renderLoop);

        async function reproducirVideo(Id, IdGrupo, Url, x, y, w, h, alpha = 1) {
            const video = document.createElement("video");
            video.src = Url;
            video.muted = true;
            video.loop = true;
            await video.play();

            const offscreen = document.createElement("canvas");
            offscreen.width = w || video.videoWidth;
            offscreen.height = h || video.videoHeight;
            const offCtx = offscreen.getContext("2d");

            elementosMap.set(Id, {
                grupo: IdGrupo,
                tipo: "video",
                recurso: video,
                offscreen,
                offCtx,
                frame: null,
                x, y, w: offscreen.width, h: offscreen.height,
                alpha
            });

            const reader = video.captureStream().getVideoTracks()[0].processor?.readable?.getReader();

            // Si no hay MediaStreamTrackProcessor, usamos drawImage directo en interval
            function drawVideoFrame() {
                const item = elementosMap.get(Id);
                item.offCtx.clearRect(0, 0, item.w, item.h);
                item.offCtx.drawImage(video, 0, 0, item.w, item.h);
                item.frame = true; // indica que hay frame listo
                requestAnimationFrame(drawVideoFrame);
            }

            drawVideoFrame();
        }


    </script>

</body>
</html>
